name: Build Windows (Spout)

on:
  workflow_dispatch:
  push:
    branches: [main]

env:
  OF_VERSION: "0.12.0"
  OF_ARCHIVE: "of_v0.12.0_msys2_mingw64_release"

jobs:
  build-windows:
    runs-on: windows-latest

    defaults:
      run:
        shell: msys2 {0}

    steps:
      - uses: actions/checkout@v4

      - name: Setup MSYS2 and dependencies
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            make unzip curl git
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-pkgconf
            mingw-w64-x86_64-assimp
            mingw-w64-x86_64-cairo
            mingw-w64-x86_64-curl
            mingw-w64-x86_64-freeimage
            mingw-w64-x86_64-glew
            mingw-w64-x86_64-glfw
            mingw-w64-x86_64-glm
            mingw-w64-x86_64-fmt
            mingw-w64-x86_64-zlib
            mingw-w64-x86_64-brotli
            mingw-w64-x86_64-libpng
            mingw-w64-x86_64-harfbuzz
            mingw-w64-x86_64-libsndfile
            mingw-w64-x86_64-libusb
            mingw-w64-x86_64-libxml2
            mingw-w64-x86_64-mpg123
            mingw-w64-x86_64-nlohmann-json
            mingw-w64-x86_64-openal
            mingw-w64-x86_64-opencv
            mingw-w64-x86_64-pugixml
            mingw-w64-x86_64-rtaudio
            mingw-w64-x86_64-uriparser
            mingw-w64-x86_64-utf8cpp
            mingw-w64-x86_64-freetype

      - name: Cache openFrameworks
        id: cache-of
        uses: actions/cache@v4
        with:
          path: D:\of
          key: of-msys2-v0.12.0-v3

      - name: Download openFrameworks
        if: steps.cache-of.outputs.cache-hit != 'true'
        run: |
          curl -L -o /tmp/of.zip \
            "https://github.com/openframeworks/openFrameworks/releases/download/${OF_VERSION}/${OF_ARCHIVE}.zip"
          mkdir -p /d/of
          cd /d/of && unzip -q /tmp/of.zip
          rm /tmp/of.zip

      - name: Clone ofxSpout addon
        run: |
          ADDON_DIR="/d/of/${OF_ARCHIVE}/addons"
          if [ ! -d "${ADDON_DIR}/ofxSpout" ]; then
            git clone --depth 1 https://github.com/elliotwoods/ofxSpout.git "${ADDON_DIR}/ofxSpout"
          fi

      - name: Setup project in oF tree
        run: |
          OF_DIR="/d/of/${OF_ARCHIVE}"
          PROJECT="${OF_DIR}/apps/myApps/VirtualStage"
          rm -rf "${PROJECT}"
          mkdir -p "${PROJECT}/src"

          cp src/*.h src/*.cpp "${PROJECT}/src/"
          cp config.make "${PROJECT}/"
          cp addons.make.win "${PROJECT}/addons.make"

          printf '%s\n' \
            'ifneq ($(wildcard config.make),)' \
            '	include config.make' \
            'endif' \
            'ifndef OF_ROOT' \
            '	OF_ROOT=../../..' \
            'endif' \
            'include $(OF_ROOT)/libs/openFrameworksCompiled/project/makefileCommon/compile.project.mk' \
            > "${PROJECT}/Makefile"

      - name: Create missing pkg-config files
        run: |
          # glm package only ships cmake config, oF needs pkg-config
          GLM_VER=$(pacman -Q mingw-w64-x86_64-glm | awk '{print $2}' | cut -d- -f1)
          cat > /mingw64/lib/pkgconfig/glm.pc << PCEOF
          prefix=/mingw64
          includedir=\${prefix}/include

          Name: glm
          Description: OpenGL Mathematics
          Version: ${GLM_VER}
          Cflags: -I\${includedir}
          PCEOF
          echo "Created glm.pc (version ${GLM_VER})"
          pkg-config --modversion glm

      - name: Build
        run: |
          export PKG_CONFIG_PATH="/mingw64/lib/pkgconfig:/mingw64/share/pkgconfig"
          cd "/d/of/${OF_ARCHIVE}/apps/myApps/VirtualStage"
          make Release -j$(nproc)

      - name: Package artifact
        shell: powershell
        run: |
          $ofDir = "D:\of\of_v0.12.0_msys2_mingw64_release"
          $binDir = "$ofDir\apps\myApps\VirtualStage\bin"

          New-Item -ItemType Directory -Path "artifact" -Force

          if (Test-Path $binDir) {
            Copy-Item -Path "$binDir\*" -Destination "artifact\" -Recurse -Force
          }

          # Bundle MinGW runtime DLLs
          $mingwBin = "C:\msys64\mingw64\bin"
          $dlls = @(
            "libstdc++-6.dll",
            "libgcc_s_seh-1.dll",
            "libwinpthread-1.dll"
          )
          foreach ($dll in $dlls) {
            $src = Join-Path $mingwBin $dll
            if (Test-Path $src) {
              Copy-Item $src "artifact\"
            }
          }

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: VirtualStage-Windows
          path: artifact/
