name: Build & Release

on:
  push:
    branches: [main]
    tags: ['v*']
  workflow_dispatch:

env:
  OF_VERSION: "0.12.0"

jobs:
  # ───────────────────────────── Windows (Spout) ─────────────────────────────
  build-windows:
    runs-on: windows-latest
    env:
      OF_ARCHIVE: of_v0.12.0_msys2_mingw64_release
    defaults:
      run:
        shell: msys2 {0}

    steps:
      - uses: actions/checkout@v4

      - name: Setup MSYS2 and dependencies
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            make unzip curl git zip
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-pkgconf
            mingw-w64-x86_64-assimp
            mingw-w64-x86_64-boost
            mingw-w64-x86_64-cairo
            mingw-w64-x86_64-curl
            mingw-w64-x86_64-freeimage
            mingw-w64-x86_64-glew
            mingw-w64-x86_64-glfw
            mingw-w64-x86_64-glm
            mingw-w64-x86_64-fmt
            mingw-w64-x86_64-zlib
            mingw-w64-x86_64-brotli
            mingw-w64-x86_64-libpng
            mingw-w64-x86_64-harfbuzz
            mingw-w64-x86_64-libsndfile
            mingw-w64-x86_64-libusb
            mingw-w64-x86_64-libxml2
            mingw-w64-x86_64-mpg123
            mingw-w64-x86_64-nlohmann-json
            mingw-w64-x86_64-openal
            mingw-w64-x86_64-opencv
            mingw-w64-x86_64-pugixml
            mingw-w64-x86_64-rtaudio
            mingw-w64-x86_64-uriparser
            mingw-w64-x86_64-utf8cpp
            mingw-w64-x86_64-freetype

      - name: Cache openFrameworks
        id: cache-of
        uses: actions/cache@v4
        with:
          path: D:\of
          key: of-msys2-v0.12.0-v5

      - name: Download openFrameworks
        if: steps.cache-of.outputs.cache-hit != 'true'
        run: |
          curl -L -o /tmp/of.zip \
            "https://github.com/openframeworks/openFrameworks/releases/download/${OF_VERSION}/${OF_ARCHIVE}.zip"
          mkdir -p /d/of
          cd /d/of && unzip -q /tmp/of.zip
          rm /tmp/of.zip

      - name: Clone ofxSpout addon
        run: |
          ADDON_DIR="/d/of/${OF_ARCHIVE}/addons"
          if [ ! -d "${ADDON_DIR}/ofxSpout" ]; then
            git clone --depth 1 https://github.com/elliotwoods/ofxSpout.git "${ADDON_DIR}/ofxSpout"
          fi

      - name: Setup project in oF tree
        run: |
          OF_DIR="/d/of/${OF_ARCHIVE}"
          PROJECT="${OF_DIR}/apps/myApps/VirtualStage"
          rm -rf "${PROJECT}"
          mkdir -p "${PROJECT}/src"

          cp src/*.h src/*.cpp "${PROJECT}/src/"
          cp config.make "${PROJECT}/"
          cp addons.make.win "${PROJECT}/addons.make"

          printf '%s\n' \
            'ifneq ($(wildcard config.make),)' \
            '	include config.make' \
            'endif' \
            'ifndef OF_ROOT' \
            '	OF_ROOT=../../..' \
            'endif' \
            'include $(OF_ROOT)/libs/openFrameworksCompiled/project/makefileCommon/compile.project.mk' \
            > "${PROJECT}/Makefile"

      - name: Create missing pkg-config files and fix boost lib names
        run: |
          GLM_VER=$(pacman -Q mingw-w64-x86_64-glm | awk '{print $2}' | cut -d- -f1)
          cat > /mingw64/lib/pkgconfig/glm.pc << PCEOF
          prefix=/mingw64
          includedir=\${prefix}/include

          Name: glm
          Description: OpenGL Mathematics
          Version: ${GLM_VER}
          Cflags: -I\${includedir} -DGLM_ENABLE_EXPERIMENTAL
          PCEOF
          echo "Created glm.pc (version ${GLM_VER})"

          # oF links -lboost_*-mt but MSYS2 boost ships without -mt suffix
          # and boost_system is header-only (no library file). Create symlinks.
          for lib in /mingw64/lib/libboost_*.dll.a; do
            mt="${lib%.dll.a}-mt.dll.a"
            [ ! -f "$mt" ] && ln -sf "$lib" "$mt" && echo "symlink: $mt"
          done
          for lib in /mingw64/lib/libboost_*.a; do
            [[ "$lib" == *".dll.a" ]] && continue
            mt="${lib%.a}-mt.a"
            [ ! -f "$mt" ] && ln -sf "$lib" "$mt" && echo "symlink: $mt"
          done
          # boost_system is header-only in modern boost; create empty archive
          if [ ! -f /mingw64/lib/libboost_system-mt.a ]; then
            ar rcs /mingw64/lib/libboost_system-mt.a
            echo "Created empty libboost_system-mt.a"
          fi

      - name: Build
        run: |
          export PKG_CONFIG_PATH="/mingw64/lib/pkgconfig:/mingw64/share/pkgconfig"
          cd "/d/of/${OF_ARCHIVE}/apps/myApps/VirtualStage"
          # -mssse3: GCC 15 requires explicit SSSE3 flag for _mm_shuffle_epi8 used in SpoutCopy.cpp
          # PROJECT_LDFLAGS: SpoutSDK uses #pragma comment(lib,...) which GCC ignores;
          # manually link d3d11, dxgi, version, shell32, advapi32, winmm, comctl32
          make Release -j$(nproc) \
            PROJECT_CFLAGS="-mssse3" \
            PROJECT_LDFLAGS="-ld3d11 -ldxgi -lversion -lshell32 -ladvapi32 -lwinmm -lcomctl32"

      - name: Package artifact
        run: |
          OF_DIR="/d/of/${OF_ARCHIVE}"
          BIN_DIR="${OF_DIR}/apps/myApps/VirtualStage/bin"

          mkdir -p artifact
          cp -r "${BIN_DIR}"/* artifact/ 2>/dev/null || true

          # Bundle all required MinGW DLLs (found via ldd)
          EXE=$(find artifact -maxdepth 1 -name '*.exe' -print -quit)
          if [ -n "$EXE" ]; then
            ldd "$EXE" | grep -i '/mingw64/' | awk '{print $3}' | while read dll; do
              [ -f "$dll" ] && cp -n "$dll" artifact/
            done
          fi

          cd artifact && zip -r "${GITHUB_WORKSPACE}/VirtualStage-Windows.zip" .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: VirtualStage-Windows
          path: VirtualStage-Windows.zip

  # ─────────────────────────── GitHub Release ────────────────────────────────
  release:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [build-windows]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            VirtualStage-Windows/VirtualStage-Windows.zip
          generate_release_notes: true
