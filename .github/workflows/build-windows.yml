name: Build & Release

on:
  push:
    branches: [main]
    tags: ['v*']
  workflow_dispatch:

env:
  OF_VERSION: "0.12.0"

jobs:
  # ───────────────────────────── Windows (Spout) ─────────────────────────────
  build-windows:
    runs-on: windows-latest
    env:
      OF_ARCHIVE: of_v0.12.0_msys2_mingw64_release
    defaults:
      run:
        shell: msys2 {0}

    steps:
      - uses: actions/checkout@v4

      - name: Setup MSYS2 and dependencies
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            make unzip curl git zip
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-pkgconf
            mingw-w64-x86_64-assimp
            mingw-w64-x86_64-boost
            mingw-w64-x86_64-cairo
            mingw-w64-x86_64-curl
            mingw-w64-x86_64-freeimage
            mingw-w64-x86_64-glew
            mingw-w64-x86_64-glfw
            mingw-w64-x86_64-glm
            mingw-w64-x86_64-fmt
            mingw-w64-x86_64-zlib
            mingw-w64-x86_64-brotli
            mingw-w64-x86_64-libpng
            mingw-w64-x86_64-harfbuzz
            mingw-w64-x86_64-libsndfile
            mingw-w64-x86_64-libusb
            mingw-w64-x86_64-libxml2
            mingw-w64-x86_64-mpg123
            mingw-w64-x86_64-nlohmann-json
            mingw-w64-x86_64-openal
            mingw-w64-x86_64-opencv
            mingw-w64-x86_64-pugixml
            mingw-w64-x86_64-rtaudio
            mingw-w64-x86_64-uriparser
            mingw-w64-x86_64-utf8cpp
            mingw-w64-x86_64-freetype

      - name: Cache openFrameworks
        id: cache-of
        uses: actions/cache@v4
        with:
          path: D:\of
          key: of-msys2-v0.12.0-v5

      - name: Download openFrameworks
        if: steps.cache-of.outputs.cache-hit != 'true'
        run: |
          curl -L -o /tmp/of.zip \
            "https://github.com/openframeworks/openFrameworks/releases/download/${OF_VERSION}/${OF_ARCHIVE}.zip"
          mkdir -p /d/of
          cd /d/of && unzip -q /tmp/of.zip
          rm /tmp/of.zip

      - name: Clone ofxSpout addon
        run: |
          ADDON_DIR="/d/of/${OF_ARCHIVE}/addons"
          if [ ! -d "${ADDON_DIR}/ofxSpout" ]; then
            git clone --depth 1 https://github.com/elliotwoods/ofxSpout.git "${ADDON_DIR}/ofxSpout"
          fi

      - name: Setup project in oF tree
        run: |
          OF_DIR="/d/of/${OF_ARCHIVE}"
          PROJECT="${OF_DIR}/apps/myApps/VirtualStage"
          rm -rf "${PROJECT}"
          mkdir -p "${PROJECT}/src"

          cp src/*.h src/*.cpp "${PROJECT}/src/"
          cp config.make "${PROJECT}/"
          cp addons.make.win "${PROJECT}/addons.make"
          cp icon.ico icon.rc "${PROJECT}/"

          printf '%s\n' \
            'ifneq ($(wildcard config.make),)' \
            '	include config.make' \
            'endif' \
            'ifndef OF_ROOT' \
            '	OF_ROOT=../../..' \
            'endif' \
            'include $(OF_ROOT)/libs/openFrameworksCompiled/project/makefileCommon/compile.project.mk' \
            > "${PROJECT}/Makefile"

      - name: Create missing pkg-config files and fix boost lib names
        run: |
          GLM_VER=$(pacman -Q mingw-w64-x86_64-glm | awk '{print $2}' | cut -d- -f1)
          cat > /mingw64/lib/pkgconfig/glm.pc << PCEOF
          prefix=/mingw64
          includedir=\${prefix}/include

          Name: glm
          Description: OpenGL Mathematics
          Version: ${GLM_VER}
          Cflags: -I\${includedir} -DGLM_ENABLE_EXPERIMENTAL
          PCEOF
          echo "Created glm.pc (version ${GLM_VER})"

          # oF links -lboost_*-mt but MSYS2 boost ships without -mt suffix
          # and boost_system is header-only (no library file). Create symlinks.
          for lib in /mingw64/lib/libboost_*.dll.a; do
            mt="${lib%.dll.a}-mt.dll.a"
            [ ! -f "$mt" ] && ln -sf "$lib" "$mt" && echo "symlink: $mt"
          done
          for lib in /mingw64/lib/libboost_*.a; do
            [[ "$lib" == *".dll.a" ]] && continue
            mt="${lib%.a}-mt.a"
            [ ! -f "$mt" ] && ln -sf "$lib" "$mt" && echo "symlink: $mt"
          done
          # boost_system is header-only in modern boost; create empty archive
          if [ ! -f /mingw64/lib/libboost_system-mt.a ]; then
            ar rcs /mingw64/lib/libboost_system-mt.a
            echo "Created empty libboost_system-mt.a"
          fi

      - name: Compile icon resource
        run: |
          cd "/d/of/${OF_ARCHIVE}/apps/myApps/VirtualStage"
          windres icon.rc -o icon.res.o
          echo "Compiled icon resource"

      - name: Build
        run: |
          export PKG_CONFIG_PATH="/mingw64/lib/pkgconfig:/mingw64/share/pkgconfig"
          cd "/d/of/${OF_ARCHIVE}/apps/myApps/VirtualStage"
          # -mssse3: GCC 15 requires explicit SSSE3 flag for _mm_shuffle_epi8 used in SpoutCopy.cpp
          # PROJECT_LDFLAGS: SpoutSDK uses #pragma comment(lib,...) which GCC ignores;
          # manually link d3d11, dxgi, version, shell32, advapi32, winmm, comctl32
          # icon.res.o: embed app icon into the executable
          make Release -j$(nproc) \
            PROJECT_CFLAGS="-mssse3" \
            PROJECT_LDFLAGS="icon.res.o -ld3d11 -ldxgi -lversion -lshell32 -ladvapi32 -lwinmm -lcomctl32"

      - name: Package artifact
        run: |
          OF_DIR="/d/of/${OF_ARCHIVE}"
          BIN_DIR="${OF_DIR}/apps/myApps/VirtualStage/bin"

          mkdir -p artifact
          cp -r "${BIN_DIR}"/* artifact/ 2>/dev/null || true

          # Bundle all required MinGW DLLs (found via ldd)
          EXE=$(find artifact -maxdepth 1 -name '*.exe' -print -quit)
          if [ -n "$EXE" ]; then
            ldd "$EXE" | grep -i '/mingw64/' | awk '{print $3}' | while read dll; do
              [ -f "$dll" ] && cp -n "$dll" artifact/
            done
          fi

          cd artifact && zip -r "${GITHUB_WORKSPACE}/VirtualStage-Windows.zip" .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: VirtualStage-Windows
          path: VirtualStage-Windows.zip

  # ───────────────────────────── macOS (Syphon) ──────────────────────────────
  build-macos:
    runs-on: macos-14
    env:
      OF_ARCHIVE: of_v0.12.0_osx_release

    steps:
      - uses: actions/checkout@v4

      - name: Cache openFrameworks
        id: cache-of-mac
        uses: actions/cache@v4
        with:
          path: ~/of
          key: of-osx-v0.12.0-v2

      - name: Download openFrameworks
        if: steps.cache-of-mac.outputs.cache-hit != 'true'
        run: |
          curl -L -o /tmp/of.tar.gz \
            "https://github.com/openframeworks/openFrameworks/releases/download/${OF_VERSION}/${OF_ARCHIVE}.tar.gz"
          mkdir -p ~/of
          cd ~/of && tar xzf /tmp/of.tar.gz
          rm /tmp/of.tar.gz

      - name: Clone ofxSyphon addon
        run: |
          ADDON_DIR=~/of/${OF_ARCHIVE}/addons
          if [ ! -d "${ADDON_DIR}/ofxSyphon" ]; then
            git clone --depth 1 https://github.com/astellato/ofxSyphon.git "${ADDON_DIR}/ofxSyphon"
          fi

      - name: Setup project in oF tree
        run: |
          OF_DIR=~/of/${OF_ARCHIVE}
          PROJECT="${OF_DIR}/apps/myApps/VirtualStage"
          rm -rf "${PROJECT}"
          mkdir -p "${PROJECT}/src"

          # Copy all source files
          cp src/*.h src/*.cpp "${PROJECT}/src/"

          # Rename Syphon-dependent files to .mm for Objective-C++ compilation
          # (make build system compiles .mm as ObjC++ automatically)
          mv "${PROJECT}/src/Scene.cpp" "${PROJECT}/src/Scene.mm"
          mv "${PROJECT}/src/ScreenObject.cpp" "${PROJECT}/src/ScreenObject.mm"

          cp config.make "${PROJECT}/"
          cp addons.make "${PROJECT}/"

          printf '%s\n' \
            'ifneq ($(wildcard config.make),)' \
            '	include config.make' \
            'endif' \
            'ifndef OF_ROOT' \
            '	OF_ROOT=../../..' \
            'endif' \
            'include $(OF_ROOT)/libs/openFrameworksCompiled/project/makefileCommon/compile.project.mk' \
            > "${PROJECT}/Makefile"

      - name: Build
        run: |
          cd ~/of/${OF_ARCHIVE}/apps/myApps/VirtualStage
          make Release -j$(sysctl -n hw.ncpu)

      - name: Package artifact
        run: |
          OF_DIR=~/of/${OF_ARCHIVE}
          BIN_DIR="${OF_DIR}/apps/myApps/VirtualStage/bin"

          # Find the .app bundle
          APP=$(find "${BIN_DIR}" -maxdepth 1 -name '*.app' -print -quit)
          if [ -z "$APP" ]; then
            echo "ERROR: No .app bundle found in ${BIN_DIR}"
            ls -la "${BIN_DIR}"
            exit 1
          fi

          echo "Found app: ${APP}"

          # Copy data folder into the bundle if it exists
          if [ -d "${BIN_DIR}/data" ]; then
            cp -r "${BIN_DIR}/data" "${APP}/Contents/Resources/"
          fi

          # Replace default oF icon with custom app icon
          if [ -f "${GITHUB_WORKSPACE}/icon.icns" ]; then
            cp "${GITHUB_WORKSPACE}/icon.icns" "${APP}/Contents/Resources/of.icns"
            echo "Replaced app icon with custom icon.icns"
          fi

          # Bundle Syphon.framework (required at runtime)
          SYPHON_FW="${OF_DIR}/addons/ofxSyphon/libs/Syphon/lib/osx/Syphon.framework"
          if [ -d "$SYPHON_FW" ]; then
            cp -R "$SYPHON_FW" "${APP}/Contents/Frameworks/"
            echo "Bundled Syphon.framework"

            # Fix rpath so the binary finds Syphon in the bundle
            BINARY="${APP}/Contents/MacOS/VirtualStage"
            install_name_tool -add_rpath @executable_path/../Frameworks "$BINARY" 2>/dev/null || true
            echo "Added @executable_path/../Frameworks rpath"
          else
            echo "WARNING: Syphon.framework not found at ${SYPHON_FW}"
          fi

          # Ad-hoc code sign (required for macOS Gatekeeper on ARM)
          codesign --force --deep -s - "${APP}"
          echo "Ad-hoc signed app bundle"

          cd "${BIN_DIR}" && zip -y -r "${GITHUB_WORKSPACE}/VirtualStage-macOS.zip" "$(basename "${APP}")"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: VirtualStage-macOS
          path: VirtualStage-macOS.zip

  # ─────────────────────────── GitHub Release ────────────────────────────────
  release:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [build-windows, build-macos]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            VirtualStage-Windows/VirtualStage-Windows.zip
            VirtualStage-macOS/VirtualStage-macOS.zip
          generate_release_notes: true
